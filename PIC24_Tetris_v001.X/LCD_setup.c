/*
 * File:   LCD_setup.c
 * Author: Jacob
 *
 * Created on November 25, 2020, 3:02 PM
 */


#include "xc.h"
#include "LCD_setup.h"

/**
 * NAME: lcdCMD
 * PARAMETERS: int cmd - a command to be sent to the LCD
 * PURPOSE: This informs the LCD that a command is going to be sent, then sends
 *  least significant 8-bits of "cmd" as the command
 * RETURNS: n/a
 */

void lcdCmd(int cmd) {
    LATB = 0XFFFF;
    LATB &= cmd;
    _LATB10 = 0; //LATB10 = A0
    _LATB11 = 0; //LATB11 = RW
    _LATB8 = 0; //LATB8 = CS
    _LATB12 = 1; //LATB12 = E
    _LATB12 = 0; //LATB12 = E
    _LATB8 = 1; //LATB8 = CS
    _LATB11 = 1; //LATB11 = RW

}

/**
 * NAME: lcdData
 * PARAMETERS: int data - a piece of data to be sent to the LCD
 * PURPOSE: This indicates to the LCD that piece of data is to be written to the
 *  screen, then sends the least significant 8-bits of "data" as that data
 * RETURNS: n/a
 */

void lcdData(int data) {
    LATB = 0XFFFF;
    LATB &= data;
    _LATB10 = 1; //LATB10 = A0
    _LATB11 = 0; //LATB11 = RW
    _LATB8 = 0; //LATB8 = CS
    _LATB12 = 1; //LATB12 = E
    _LATB12 = 0; //LATB12 = E
    _LATB8 = 1; //LATB8 = CS
    _LATB11 = 1; //LATB11 = RW
}

/**
 * NAME: initLCD
 * PARAMETERS: n/a
 * PURPOSE: The general initialization of the LCD screen as instructed in the 
 * data sheet. See page 11. 
 * https://www.digikey.com/htmldatasheets/production/832148/0/0/1/nhd-c12864lz-fsw-fbw-3v3.html
 * RETURNS: n/a
 */

void initLCD(void) {
    _LATB9 = 0;
    _TON = 1;
    while (!_T1IF);

    _LATB9 = 1; //LATB9 = RES
    _TON = 1;
    while (!_T1IF);

    _LATB8 = 1; //LATB8 = CS
    _LATB12 = 1; //LATB12 = E
    _LATB11 = 1; //LATB11 = RW
    _LATB10 = 1; //LATB10 = A0

    lcdCmd(0xffa2);
    lcdCmd(0xffa0);
    lcdCmd(0xffc8);
    lcdCmd(0xffa4);
    lcdCmd(0xff40);
    lcdCmd(0xff25);
    lcdCmd(0xff81);
    lcdCmd(0xff10);
    lcdCmd(0xff2f);
    lcdCmd(0xffaf);
}

/**
 * NAME: clearLCD
 * PARAMETERS: n/a
 * PURPOSE: Clears the LCD screen, writing all pixels as "Off"
 * RETURNS: n/a
 */

void clearLCD(void) {
    unsigned int i, j;
    unsigned int page = 0xffB0;
    lcdCmd(0xff40); //Display start address + 0x40
    for (i = 0; i < 8; i++) { //64pixel display / 8 pixels per page = 8 pages
        lcdCmd(page); //send page address
        lcdCmd(0xff10); //column address upper 4 bits + 0x10
        lcdCmd(0xff00); //column address lower 4 bits + 0x00
        for (j = 0; j < 128; j++) { //128 columns wide
            lcdData(0xff00); //send picture data

        }
        page++; //after 128 columns, go to next page
    }
}

/**
 * NAME: drawNHDLogo
 * PARAMETERS: n/a
 * PURPOSE: An example provided by NHD to test the functionality of the screen,
 * provides a size 1024 array that will write the NHD logo. 
 * RETURNS: n/a
 */

void drawNHDLogo() {
    unsigned int NHD_Logo[] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x80, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x7C, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
        0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0xF8, 0xF8, 0xF0, 0x00, 0x00, 0xF8, 0xF8, 0x00, 0x00, 0x00,
        0x00, 0xC0, 0xF0, 0x78, 0x78, 0x78, 0x78, 0x78, 0x00, 0x00, 0x00, 0xF8, 0xF0, 0x00, 0x00, 0x00,
        0xF8, 0xF8, 0xC0, 0x00, 0x00, 0xC0, 0xF8, 0xF8, 0x00, 0x00, 0x00, 0xF8, 0xF8, 0x00, 0x00, 0x00,
        0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF8, 0xF8, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xF8, 0xF8, 0xC0, 0x00, 0x00, 0x00, 0xF8, 0xF8, 0x00, 0x00, 0x00, 0x80, 0xF0, 0xF0, 0x78, 0x78,
        0x78, 0x78, 0x00, 0x00, 0x00, 0xF8, 0xF8, 0xF8, 0xC0, 0x00, 0x00, 0xF8, 0xF8, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x07, 0x0B, 0x1F, 0x1F, 0x17, 0x0B, 0x01, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0xF0, 0xF0,
        0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0x00, 0xFF, 0x01, 0x07, 0xF8, 0xC0, 0xFF, 0xFF, 0x00, 0x00, 0x00,
        0x00, 0xFF, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xF8, 0x00, 0xFF,
        0x7F, 0x03, 0xFF, 0xE0, 0x00, 0xFF, 0x3F, 0x03, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x78, 0x70, 0x78,
        0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xBF, 0x8F, 0x81, 0xFF, 0xF8, 0x00, 0x00, 0x00, 0x00,
        0x0F, 0x3F, 0xFF, 0x00, 0xE0, 0xF8, 0x0F, 0x01, 0x00, 0x00, 0xF8, 0xFF, 0x79, 0x78, 0x70, 0x70,
        0x70, 0x70, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x1F, 0xF0, 0xE0, 0xFF, 0xFF, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF8, 0xFE, 0xFF, 0xFF, 0xF8, 0xD0,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xB8, 0x3C, 0x07, 0x03, 0x80, 0xF0, 0xF0, 0xF0,
        0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0x00, 0xFF, 0x00, 0x00, 0x03, 0x3F, 0xFF, 0xFF, 0x00, 0x00, 0x00,
        0x00, 0x1F, 0x78, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x03, 0xFF, 0xFF, 0x7F,
        0x00, 0x00, 0x1F, 0xFF, 0xFE, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00,
        0xFF, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xFF, 0x07, 0x07, 0x07, 0x07, 0x3F, 0xFF, 0x80, 0x00, 0x00,
        0x00, 0x00, 0x01, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0F, 0x7C, 0x78, 0xF0, 0xF0,
        0xF0, 0xF0, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x07, 0x1F, 0xFF, 0xFF, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x3F, 0xFF, 0xFF, 0xFF, 0x7F, 0x1B,
        0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0E, 0x0F, 0x03, 0x00, 0x00, 0xE0, 0x7C, 0x0F, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0x80, 0x00, 0x00, 0x00,
        0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0x00,
        0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00,
        0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x80, 0xF0, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0xE0, 0xF4, 0xFE, 0xFF, 0xFE, 0xFC, 0x80, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xF0, 0x2E, 0x1D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x07, 0xFF, 0x00, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x7F, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0x00, 0x00,
        0x00, 0x00, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0x07, 0x3F, 0xFE, 0xE0, 0x00, 0x00, 0x00,
        0x00, 0x03, 0x07, 0xF8, 0xFE, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x0F, 0x7F, 0xFF, 0xFF, 0xFF, 0x3F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
        0x0F, 0x0F, 0x0F, 0x0F, 0x0B, 0x0F, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xE0, 0xE0, 0xE0, 0xE0, 0xFC, 0x3F, 0x00, 0x00, 0x00,
        0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0xE0, 0xE0, 0xE0, 0xE1, 0xF1, 0xFF, 0x00, 0x00,
        0x00, 0x00, 0xFF, 0xFF, 0x03, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xE0,
        0xE0, 0xE0, 0xE0, 0x00, 0x00, 0x80, 0xF8, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0xFF, 0xE0, 0x00, 0x00,
        0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
        0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    unsigned int i, j, count = 0;
    unsigned int page = 0xffB0;
    lcdCmd(0xff40); //Display start address + 0x40
    for (i = 0; i < 8; i++) { //64pixel display / 8 pixels per page = 8 pages
        lcdCmd(page); //send page address
        lcdCmd(0xff10); //column address upper 4 bits + 0x10
        lcdCmd(0xff00); //column address lower 4 bits + 0x00
        for (j = 0; j < 128; j++) { //128 columns wide
            lcdData(NHD_Logo[count] | 0xff00); //send picture data
            count++;
        }
        page++; //after 128 columns, go to next page
    }
}

/**
 * NAME: initScreenBuf
 * PARAMETERS: unsigned char screen[1024] - an array of 8 bit numbers
 * PURPOSE: Takes the passed in array and initializes all the values to 0, so if 
 * the array were to be written to the screen, it would be blank
 * RETURNS: n/a
 */

void initScreenBuf(unsigned char screen[1024]) {
    int i;
    for (i = 0; i < 1024; i++) {
        screen[i] = 0x00;
    }

}

/**
 * NAME: initPlayField
 * PARAMETERS: unsigned char pField[1024] - an array of 8 bit numbers
 * PURPOSE: This creates the playing field used in our tetris game, which is a 
 * border around the sides and the bottom
 * RETURNS: n/a
 */

void initPlayField(unsigned char pField[1024]) {
    int fx, fy;
    for (fy = 0; fy < 8; fy++) {
        for (fx = 0; fx < 128; fx++) {
            if (fy == 0 || fy == 7) {
                pField[fy * 128 + fx] = 0xff;
            } else if (fx > 119) {
                pField[fy * 128 + fx] = 0xff;
            } else {
                pField[fy * 128 + fx] = 0x00;
            }

        }
    }

}

/**
 * NAME: drawField
 * PARAMETERS: unsigned char pField[1024] - the playing field that was created 
 *  in initPlayField
 *  unsigned char screen[1024] - the array of pixel data that gets continually
 *  written to the screen throughout the game
 * PURPOSE: the 'screen' array contains the pixel data of what is being displayed
 *  on the screen, and this function adds the playing field to that data (aka 
 *  adds the borders so they are continually written) 
 * RETURNS: n/a
 */

void drawField(unsigned char pField[1024], unsigned char screen[1024]) {
    int i;
    for (i = 0; i < 1024; i++) {
        screen[i] = pField[i];
    }
    //Could use memcpy() from std string to speed this up

}

/**
 * NAME: drawScreenBuf
 * PARAMETERS: unsigned char screen[1024] - the array of pixel data that gets continually
 *  written to the screen throughout the game
 * PURPOSE: updates the game screen with any changes in visuals, which will be 
 *  in the passed 'screen' array
 * RETURNS: n/a
 */

void drawScreenBuf(unsigned char screen[1024]) {
    unsigned int i, j, count = 0;
    unsigned int page = 0xffB0;
    lcdCmd(0xff40); //Display start address + 0x40
    for (i = 0; i < 8; i++) { //64pixel display / 8 pixels per page = 8 pages
        lcdCmd(page); //send page address
        lcdCmd(0xff10); //column address upper 4 bits + 0x10
        lcdCmd(0xff00); //column address lower 4 bits + 0x00
        for (j = 0; j < 128; j++) { //128 columns wide
            lcdData(screen[count] | 0xff00); //send picture data
            count++;
        }
        page++; //after 128 columns, go to next page
    }
}